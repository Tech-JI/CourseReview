<!DOCTYPE html>
<html lang="zh-CN" class="h-full bg-white">
<head>
    <meta charset="UTF-8">
    <title>JIé€‰è¯¾ç¤¾åŒºèº«ä»½éªŒè¯</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <!-- å¼•å…¥Tailwind CSS (ç”Ÿäº§ç¯å¢ƒå»ºè®®æ„å»ºåå¼•å…¥) -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full">
    <script>
    const SESSION_ID = "{{ request.session.session_key }}";
    console.log("å½“å‰ session_id:", SESSION_ID);
    
    // åœ¨è¡¨å•æäº¤æˆåŠŸå¹¶æ˜¾ç¤ºéªŒè¯ç åï¼Œè°ƒç”¨ complete_login API
    async function completeLogin() {
        const response = await fetch('/verify/complete_login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // è·å– CSRF token
            },
            body: JSON.stringify({ session_id: SESSION_ID })
        });
        
        const data = await response.json();
        console.log("Complete login response:", data);
        
        if (data.status === "success") {
            // ç™»å½•æˆåŠŸï¼Œé‡å®šå‘åˆ° CourseReview ä¸»é¡µ
            window.location.href = "/"; 
        } else {
            console.error("Complete login failed:", data.detail);
            document.getElementById('result').innerHTML = `
                <div class="rounded-md bg-red-50 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">ç™»å½•å¤±è´¥</h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>${data.detail || "ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè·å– cookie å€¼
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>

    <div class="flex min-h-full flex-1 flex-col justify-center px-6 py-12 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-sm">
            <!-- å¦‚æœæœ‰Logoå¯ä»¥æ”¾åœ¨è¿™é‡Œ -->
            <!-- <img class="mx-auto h-10 w-auto" src="/path/to/logo.svg" alt="Logo" /> -->
            <h1 class="mt-10 text-center text-2xl font-bold leading-9 tracking-tight text-gray-900">
                JIé€‰è¯¾ç¤¾åŒºèº«ä»½éªŒè¯ç³»ç»Ÿ
            </h1>
        </div>
          
        <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-sm">
            <form id="verify-form" method="POST" action="{% url 'verify_turnstile' %}" class="space-y-6">
                {% csrf_token %}
                <div>
                    <div class="cf-turnstile"
                         data-sitekey="{{ TURNSTILE_SITE_KEY }}"
                         data-domain="032bb397fcfb.ngrok-free.app"
                         data-callback="onSuccess"
                         data-expired-callback="onExpired">
                    </div>
                </div>
                <input type="hidden" name="session_id" value="{{ request.session.session_key }}">
                <div>
                    <button type="submit" id="submit-btn" disabled
                            class="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                        è·å–8ä½éªŒè¯ç 
                    </button>
                </div>
            </form>
           

            <div id="countdown" class="mt-4 text-center text-sm text-gray-500"></div>
            <div id="result" class="mt-4"></div>
            <div id="code" class="mt-6 text-center text-2xl font-bold text-gray-900"></div>
            
        </div>
    </div>

    <script>
        function onExpired() {
            console.warn("Turnstile éªŒè¯å·²è¿‡æœŸï¼Œé‡æ–°åŠ è½½");
            turnstile.reset(); // é‡æ–°åŠ è½½éªŒè¯
            document.getElementById("submit-btn").disabled = true;
        }

        function onSuccess(token) {
            document.getElementById("submit-btn").disabled = false;
        }

        const form = document.getElementById('verify-form');
        const codeDiv = document.getElementById('code');
        const resultDiv = document.getElementById('result');
        //è¡¨å•æäº¤é€»è¾‘
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById("submit-btn");
            submitBtn.disabled = true;

            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                currentCode = data.code;
                codeDiv.textContent = `ä½ çš„éªŒè¯ç æ˜¯ï¼š${data.code}`;
                try {
                    await navigator.clipboard.writeText(data.code);
                    console.log("éªŒè¯ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
                } catch (err) {
                    console.error("å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:", err);
                }
                
                // ä½¿ç”¨Tailwindæ ·å¼æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                resultDiv.innerHTML = `
                    <div class="rounded-md bg-green-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-green-800">éªŒè¯é€šè¿‡ï¼Œå·²å¤åˆ¶éªŒè¯ç </p>
                            </div>
                        </div>
                    </div>
                `;
                
                startCountdown(60);
                //æ‰“å¼€é—®å·
                setTimeout(() => {
                    window.open("{{ SURVEY_URL }}", "_blank", "width=800,height=600");
                }, 1000);
            } else {
                // ä½¿ç”¨Tailwindæ ·å¼æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                resultDiv.innerHTML = `
                    <div class="rounded-md bg-red-50 p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">éªŒè¯å¤±è´¥</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <p>${data.error || "è¯·å®ŒæˆéªŒè¯ç éªŒè¯"}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        });

        function startCountdown(seconds) {
            const countdownEl = document.getElementById('countdown');
            const timer = setInterval(() => {
                seconds--;
                countdownEl.textContent = `${seconds}ç§’åè¿‡æœŸ`;
                if (seconds <= 0) {
                    clearInterval(timer);
                    countdownEl.textContent = "éªŒè¯ç å·²è¿‡æœŸ";
                }
            }, 1000);
        }

        // SSEè¿æ¥é€»è¾‘
    document.addEventListener('DOMContentLoaded', function() {
        const sse = new EventSource(`/verify/sse/?session_id=${SESSION_ID}`);
       
        sse.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log("SSE received:", data);
                    if (data.status === "fully_verified") {
                         // æ›´æ–°é¡µé¢ DOMï¼Œæ˜¾ç¤º Welcome
                         //const resultDiv = document.getElementById("result");
                        // ä½¿ç”¨Tailwindæ ·å¼æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                        resultDiv.innerHTML = `
                            <div class="rounded-md bg-blue-50 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-blue-800">ğŸ‰ æ¬¢è¿ä½ ï¼Œ${data.name}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        sse.close();
                        
                        // è°ƒç”¨ completeLogin å‡½æ•°å®Œæˆç™»å½•æµç¨‹
                        completeLogin();
                    }
                } catch (e) {
                    console.error("è§£æSSEæ•°æ®å¤±è´¥:", e);
                }
            };
            
            sse.onerror = function (event) {
                console.error("SSEè¿æ¥é”™è¯¯:", event);
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‡è¿é€»è¾‘
            };
        });
    </script>
</body>
</html>
